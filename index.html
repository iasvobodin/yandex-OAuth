<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –æ–±—â–∏–π –¥–∏—Å–∫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 15px;
            margin: 0;
            background: #fafafa;
            color: #333;
        }

        h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        #controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            padding: 10px 16px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background: #4a90e2;
            color: white;
            font-size: 0.9rem;
            flex: 1 1 auto;
            max-width: 220px;
        }

        button:hover {
            background: #357abd;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .thumb {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .thumb img {
            width: 180px;
            height: auto;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .file-info {
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 6px;
            word-break: break-word;
        }

        .progress-container {
            width: 100%;
            background: #eee;
            border-radius: 6px;
            overflow: hidden;
            height: 8px;
            margin-bottom: 6px;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: #4a90e2;
            transition: width 0.2s ease;
        }

        .status {
            font-size: 0.85rem;
            font-weight: bold;
            text-align: center;
        }

        .status.waiting {
            color: #888;
        }

        .status.uploading {
            color: #e69500;
        }

        .status.success {
            color: #2d9d2d;
        }

        .status.error {
            color: #d93025;
        }

        #output {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
            font-size: 0.8rem;
            white-space: pre-wrap;
            border-radius: 6px;
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <h2 id="info">–í—ã –∑–∞–≥—Ä—É–∂–∞–µ—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–∞ –æ–±—â–∏–π –¥–∏—Å–∫</h2>

    <div id="controls">
        <input type="file" id="fileInput" accept="image/*,video/*" multiple capture="environment"
            style="display:none" />
        <button id="authBtn">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
        <button id="selectBtn" disabled>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</button>
        <button id="uploadBtn" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ</button>
    </div>

    <div id="preview"></div>

    <pre id="output"></pre>

    <script>
        const AUTH_URL = '/api/auth';
        const GET_UPLOAD_URL = '/api/get-upload-url';

        let filesToUpload = [];
        let folderName = '–§–æ—Ç–æ';
        let subfolderName = '–ù–æ–≤–∞—è –ø–∞–ø–∫–∞';

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('folder') || urlParams.has('subfolder')) {
            const data = {
                folder: urlParams.get('folder'),
                subfolder: urlParams.get('subfolder')
            };
            sessionStorage.setItem('uploadData', JSON.stringify(data));
        }

        const storedData = sessionStorage.getItem('uploadData');
        if (storedData) {
            const data = JSON.parse(storedData);
            folderName = data.folder || folderName;
            subfolderName = data.subfolder || subfolderName;
        }

        document.getElementById("info").textContent = `–í—ã –∑–∞–≥—Ä—É–∂–∞–µ—Ç–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É "${folderName}" –ø–æ–¥ –∏–º–µ–Ω–µ–º "${subfolderName}-***"`;

        const output = document.getElementById("output");
        function log(msg) { output.textContent += msg + "\n"; }

        const authBtn = document.getElementById("authBtn");
        const selectBtn = document.getElementById("selectBtn");
        const uploadBtn = document.getElementById("uploadBtn");
        const fileInput = document.getElementById("fileInput");

        async function checkAuthStatus() {
            try {
                const res = await fetch(AUTH_URL, { method: 'HEAD' });
                if (res.ok) {
                    log("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!");
                    authBtn.style.display = 'none';
                    selectBtn.disabled = false;
                    uploadBtn.disabled = false;
                } else {
                    log("‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.");
                    authBtn.style.display = 'block';
                    selectBtn.disabled = true;
                    uploadBtn.disabled = true;
                }
            } catch (err) {
                log("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.");
                authBtn.style.display = 'block';
            }
        }

        window.addEventListener('load', checkAuthStatus);

        authBtn.onclick = () => {
            log("–ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...");
            window.location.href = AUTH_URL;
        };

        selectBtn.onclick = () => fileInput.click();

        fileInput.onchange = (event) => {
            filesToUpload = Array.from(event.target.files);
            const previewDiv = document.getElementById("preview");
            previewDiv.innerHTML = "";
            filesToUpload.forEach(file => {
                const div = document.createElement("div");
                div.className = "thumb";
                const infoDiv = document.createElement("div");
                infoDiv.className = "file-info";
                infoDiv.textContent = file.name;
                const progressContainer = document.createElement("div");
                progressContainer.className = "progress-container";
                const progressBar = document.createElement("div");
                progressBar.className = "progress-bar";
                progressContainer.appendChild(progressBar);
                const statusDiv = document.createElement("div");
                statusDiv.className = "status waiting";
                statusDiv.textContent = "‚è≥ –û–∂–∏–¥–∞–µ—Ç";
                div.appendChild(infoDiv);
                div.appendChild(progressContainer);
                div.appendChild(statusDiv);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–≤—å—é
                if (file.type.startsWith('image/')) {
                    const img = document.createElement("img");
                    img.src = URL.createObjectURL(file);
                    div.prepend(img);
                } else if (file.type.startsWith('video/')) {
                    // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é –¥–ª—è –≤–∏–¥–µ–æ
                    createVideoThumbnail(file, img => {
                        div.prepend(img);
                    });
                } else {
                    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
                    const icon = document.createElement("div");
                    icon.textContent = "üìé";
                    icon.style.fontSize = "50px";
                    icon.style.height = "150px";
                    icon.style.display = "flex";
                    icon.style.alignItems = "center";
                    icon.style.justifyContent = "center";
                    div.prepend(icon);
                }

                previewDiv.appendChild(div);
                file._statusEl = statusDiv;
                file._progressEl = progressBar;
            });
        };

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–≤—å—é –≤–∏–¥–µ–æ
        function createVideoThumbnail(file, callback) {
            const video = document.createElement('video');
            video.preload = 'metadata';
            video.onloadedmetadata = function () {
                video.currentTime = 1; // –ë–µ—Ä–µ–º –∫–∞–¥—Ä –Ω–∞ 1 —Å–µ–∫—É–Ω–¥–µ
            };
            video.onseeked = function () {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const img = document.createElement("img");
                img.src = canvas.toDataURL('image/jpeg');
                img.onload = () => {
                    URL.revokeObjectURL(video.src);
                    callback(img);
                };
            };
            video.src = URL.createObjectURL(file);
        }

        uploadBtn.onclick = async () => {
            if (filesToUpload.length === 0) {
                log("–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.");
                return;
            }

            log("–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É...");
            for (let file of filesToUpload) {
                try {
                    file._statusEl.className = "status uploading";
                    file._statusEl.textContent = "‚¨Ü –ó–∞–≥—Ä—É–∑–∫–∞...";
                    file._progressEl.style.width = "0%";

                    const getUrlRes = await fetch(GET_UPLOAD_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fileName: file.name,
                            folder: folderName,
                            subfolder: subfolderName
                        })
                    });

                    if (!getUrlRes.ok) {
                        const errorData = await getUrlRes.json();
                        throw new Error(errorData.error);
                    }

                    const { uploadUrl, newFileName } = await getUrlRes.json();

                    await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open('PUT', uploadUrl, true);
                        xhr.upload.onprogress = (e) => {
                            if (e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);
                                file._progressEl.style.width = percent + "%";
                            }
                        };
                        xhr.onload = () => {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                resolve();
                            } else {
                                reject(new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${xhr.status}`));
                            }
                        };
                        xhr.onerror = () => reject(new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞'));
                        xhr.send(file);
                    });

                    log(`–§–∞–π–ª "${file.name}" —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ "${newFileName}" –≤ "${folderName}".`);
                    file._statusEl.className = "status success";
                    file._statusEl.textContent = "‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ";
                    file._progressEl.style.width = "100%";
                } catch (err) {
                    log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ "${file.name}": ${err.message}`);
                    file._statusEl.className = "status error";
                    file._statusEl.textContent = "‚ùå –û—à–∏–±–∫–∞";
                    file._progressEl.style.background = "#d93025";
                }
            }

            filesToUpload = [];
            fileInput.value = "";
        };
    </script>
</body>

</html>